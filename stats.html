<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Join & Stats</title>
  <style>
    body { background: #000; color: #ffcc00; text-align: center; font-family: sans-serif; padding: 20px; }
    #logo, #noGame { margin-top: 50px; font-size: 2rem; }
    video, canvas { border: 2px solid #ffcc00; margin-top: 10px; width: 320px; }
    .stat { margin: 10px 0; font-size: 1.2rem; }
  </style>
</head>
<body>
  <h1>Join Game / Your Stats</h1>

  <div id="joinArea">
    <input type="text" id="name" placeholder="Enter name" /><br/>
    <button id="takePic">Take Picture</button><br/>
    <div id="camera" style="display:none;">
      <video id="vid" autoplay></video><br/>
      <button id="snap">Snap</button>
    </div>
  </div>

  <div id="noGame" style="display:none;">
    <img id="logo" src="assets/Logo.png" alt="Logo" /><br/>
    NO GAME ACTIVE
  </div>

  <div id="statsArea" style="display:none;">
    <h2>Your Stats</h2>
    <div class="stat" id="yourStats"></div>
    <h3>Players Joined:</h3>
    <div id="playerList"></div>
  </div>

<script>
// State variables
let joinedName = null;

// Join flow
document.getElementById('takePic').onclick = async () => {
  const name = document.getElementById('name').value.trim();
  if (!name) return alert('Enter your name');
  const stream = await navigator.mediaDevices.getUserMedia({video:true});
  const vid = document.getElementById('vid');
  vid.srcObject = stream;
  document.getElementById('camera').style.display = 'block';

  document.getElementById('snap').onclick = () => {
    const canvas = document.createElement('canvas');
    canvas.width = vid.videoWidth;
    canvas.height = vid.videoHeight;
    canvas.getContext('2d').drawImage(vid, 0, 0);
    const img = canvas.toDataURL();
    stream.getTracks().forEach(t => t.stop());
    const arr = JSON.parse(localStorage.getItem('darts_joined')||'[]');
    if (!arr.some(p=>p.name===name)) {
      arr.push({name,img});
      localStorage.setItem('darts_joined', JSON.stringify(arr));
    }
    joinedName = name;
    document.getElementById('joinArea').style.display = 'none';
    refresh();
  };
};

// Refresh display
function refresh() {
  const game = JSON.parse(localStorage.getItem('darts_game') || '{}');
  if (!game.active) {
    document.getElementById('noGame').style.display = 'block';
    document.getElementById('statsArea').style.display = 'none';
    return;
  }
  document.getElementById('noGame').style.display = 'none';
  document.getElementById('statsArea').style.display = 'block';

  const stats = game.scores[joinedName];
  document.getElementById('yourStats').innerText =
    `Throws: ${stats.throws} | Avg Points: ${ (stats.total / stats.throws || 0).toFixed(2) }` +
    (stats.score !== undefined ? ` | Remaining: ${stats.score}` : '');

  const players = JSON.parse(localStorage.getItem('darts_joined') || '[]');
  document.getElementById('playerList').innerHTML = players.map(p =>
    `<div><img src="${p.img}" style="width:40px;vertical-align:middle" /> ${p.name}</div>`
  ).join('');
}

// Listen for game updates
window.addEventListener('storage', e => {
  if (e.key === 'darts_game') refresh();
});

// Initial
if (localStorage.getItem('darts_logo') === 'on') {
  document.getElementById('logo').style.display = 'block';
}
refresh();
</script>
</body>
</html>
