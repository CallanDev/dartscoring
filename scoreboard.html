<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Darts Scoreboard</title>
<style>
  html, body {
    margin: 0; padding: 0; height: 100%;
    background: radial-gradient(circle at center, #0a0a0a 0%, #121212 90%);
    color: #ffcc00;
    font-family: 'Arial Black', Arial, sans-serif;
    user-select: none;
  }
  h1 {
    text-align: center;
    font-size: 3rem;
    margin: 20px 0 10px;
    text-shadow: 0 0 8px #ffcc00;
  }
  #matchInfo {
    text-align: center;
    font-size: 1.5rem;
    margin-bottom: 20px;
    letter-spacing: 1px;
  }
  #scoreTable {
    width: 100%;
    max-width: 100%;
    border-collapse: collapse;
    margin: 0 auto;
  }
  #scoreTable th, #scoreTable td {
    border: 3px solid #ffcc00;
    padding: 20px 15px;
    font-size: 1.8rem;
    text-align: center;
  }
  #scoreTable th {
    background: #333300;
  }
  #scoreTable td.playerName {
    font-weight: bold;
    text-align: left;
    padding-left: 30px;
  }
  #scoreTable td.lastThrow {
    color: #00ff00;
    font-weight: bold;
  }
  #popup {
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(34, 34, 0, 0.9);
    color: #fff;
    font-size: 5rem;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
    font-weight: 900;
    letter-spacing: 2px;
    z-index: 9999;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease;
  }
  #finalResults {
    max-width: 600px;
    margin: 40px auto 0;
    background: #222200cc;
    border: 3px solid #ffcc00;
    border-radius: 15px;
    padding: 30px;
    font-size: 1.5rem;
  }
  #finalResults h2 {
    text-align: center;
    margin-bottom: 25px;
  }
  #finalResults ol {
    font-size: 1.5rem;
    padding-left: 30px;
  }
  /* Winner animation */
  @keyframes winnerFlash {
    0%, 100% { text-shadow: 0 0 30px #ffcc00, 0 0 60px #ffcc00, 0 0 90px #ffcc00; color: #ffcc00;}
    50% { text-shadow: 0 0 10px #fff, 0 0 30px #fff; color: #fff;}
  }
  #winnerAnimation {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 7rem;
    color: #ffcc00;
    font-weight: 900;
    text-align: center;
    z-index: 10000;
    animation: winnerFlash 2s infinite;
  }
</style>
</head>
<body>

<h1>Darts Scoreboard</h1>
<div id="matchInfo"></div>

<table id="scoreTable">
  <thead>
    <tr>
      <th>Player</th>
      <th>Score</th>
      <th>Last Throw</th>
      <th>Average</th>
    </tr>
  </thead>
  <tbody id="scoreBody"></tbody>
</table>

<div id="finalResults" class="hidden"></div>

<div id="popup"></div>
<div id="winnerAnimation" class="hidden"></div>

<script>
let dartsData = null;
let popupTimeout = null;
let tournamentFinalPlacements = null;

function loadGameData() {
  const rawData = localStorage.getItem("darts_game");
  if (!rawData) {
    document.getElementById("matchInfo").textContent = "No active game found.";
    return null;
  }
  try {
    return JSON.parse(rawData);
  } catch {
    document.getElementById("matchInfo").textContent = "Error loading game data.";
    return null;
  }
}

function renderScores() {
  if (!dartsData) return;

  const match = dartsData.players;
  const scores = dartsData.scores;
  const currentPlayerIndex = dartsData.currentPlayerIndex;

  document.getElementById("matchInfo").textContent = `Match: ${match.join(" vs ")}`;

  const tbody = document.getElementById("scoreBody");
  tbody.innerHTML = "";

  for (const player of match) {
    const playerData = scores[player];
    let lastThrow = playerData.history.length ? playerData.history[playerData.history.length - 1] : "-";
    if (lastThrow === 0) lastThrow = "0";
    const avg = playerData.average || 0;
    const highlight = (match[currentPlayerIndex] === player) ? "style='background:#333300'" : "";

    tbody.innerHTML += `
      <tr ${highlight}>
        <td class="playerName">${player}</td>
        <td>${playerData.score}</td>
        <td class="lastThrow">${lastThrow}</td>
        <td>${avg}</td>
      </tr>
    `;
  }
}

// Popup display function
function showPopup(message) {
  const popup = document.getElementById("popup");
  popup.textContent = message;
  popup.style.opacity = "1";
  popup.style.pointerEvents = "auto";

  if (popupTimeout) clearTimeout(popupTimeout);
  popupTimeout = setTimeout(() => {
    popup.style.opacity = "0";
    popup.style.pointerEvents = "none";
  }, 4000);
}

// Check for popup messages in localStorage
function checkPopup() {
  const popupRaw = localStorage.getItem("darts_popup");
  if (!popupRaw) return;

  try {
    const data = JSON.parse(popupRaw);
    const now = Date.now();
    if (now - data.timestamp < 4000) {
      showPopup(data.message);
    } else {
      localStorage.removeItem("darts_popup");
    }
  } catch {
    localStorage.removeItem("darts_popup");
  }
}

// Load final results from localStorage
function loadFinalResults() {
  const finalRaw = localStorage.getItem("darts_final_results");
  if (!finalRaw) return null;
  try {
    return JSON.parse(finalRaw);
  } catch {
    return null;
  }
}

// Display final tournament results
function showFinalResults(players) {
  if (!players) return;
  const container = document.getElementById("finalResults");
  container.classList.remove("hidden");

  container.innerHTML = `
    <h2>üèÜ Tournament Final Placements üèÜ</h2>
    <ol>
      ${players.map((p) => `<li>${p}</li>`).join("")}
    </ol>
  `;

  // Show winner animation for first player
  showWinnerAnimation(players[0]);
}

// Winner animation overlay
function showWinnerAnimation(winner) {
  const anim = document.getElementById("winnerAnimation");
  anim.textContent = `üéâ ${winner} Wins! üéâ`;
  anim.classList.remove("hidden");
}

// Main update loop
function update() {
  dartsData = loadGameData();

  if (dartsData) {
    document.getElementById("finalResults").classList.add("hidden");
    document.getElementById("winnerAnimation").classList.add("hidden");

    renderScores();
    checkPopup();
  } else {
    tournamentFinalPlacements = loadFinalResults();

    if (tournamentFinalPlacements) {
      showFinalResults(tournamentFinalPlacements);
    } else {
      document.getElementById("matchInfo").textContent = "No active game or final results.";
      document.getElementById("scoreBody").innerHTML = "";
      document.getElementById("finalResults").classList.add("hidden");
      document.getElementById("winnerAnimation").classList.add("hidden");
    }
  }
}

// Refresh every second
setInterval(update, 1000);
update();
</script>

</body>
</html>
