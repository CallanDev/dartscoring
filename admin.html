<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Darts Admin</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #121212;
    color: #eee;
    margin: 20px;
  }
  h1, h2 {
    color: #ffcc00;
  }
  input, select, button {
    padding: 8px;
    margin: 5px 0;
    font-size: 1rem;
    border-radius: 6px;
    border: none;
    outline: none;
  }
  input[type="text"] {
    width: 200px;
  }
  button {
    background-color: #ffcc00;
    color: #121212;
    cursor: pointer;
    font-weight: bold;
  }
  button:hover {
    background-color: #e6b800;
  }
  .section {
    margin-bottom: 20px;
  }
  #playerList li {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
  }
  #playerList img {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    margin-right: 10px;
    object-fit: cover;
    border: 2px solid #ffcc00;
  }
  /* Camera popup styles */
  #cameraPopup {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    visibility: hidden;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  #cameraPopup.visible {
    visibility: visible;
    opacity: 1;
  }
  #cameraContainer {
    background: #222;
    border: 3px solid #ffcc00;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    max-width: 400px;
  }
  #videoElement {
    width: 320px;
    height: 240px;
    background: #000;
    border-radius: 8px;
  }
  #captureButton, #cancelCaptureButton {
    margin: 10px;
    padding: 10px 15px;
    font-size: 1rem;
    cursor: pointer;
  }
  #snapshotPreview {
    margin-top: 10px;
    max-width: 320px;
    border-radius: 8px;
    display: none;
  }

  /* Freeze toggle button styling */
  #freezeToggleBtn {
    padding: 10px 20px;
    font-weight: bold;
    border: none;
    border-radius: 6px;
  }
</style>
</head>
<body>

<h1>Darts Admin</h1>

<div id="setupSection" class="section">
  <h2>Game Setup</h2>

  <label>Game Mode:</label>
  <select id="gameMode">
    <option value="301">301</option>
    <option value="501" selected>501</option>
    <option value="701">701</option>
  </select>
  <br />

  <label>Tournament Mode:</label>
  <input type="checkbox" id="tournamentMode" />

  <div class="section" style="margin-top:15px;">
    <label>Add Player:</label>
    <input type="text" id="playerName" placeholder="Enter player name" autocomplete="off" />
    <button id="addPlayerBtn">Add</button>
  </div>

  <ul id="playerList"><li>No players added yet</li></ul>

  <div id="tournamentMatches" class="match-selectors hidden" style="margin-top:15px;"></div>

  <button onclick="startGame()">Start Game</button>

  <button id="freezeToggleBtn" onclick="toggleFreezeScreen()" style="margin-top: 20px; background-color:#c0392b; color:#fff;">FREEZE SCREEN OFF</button>
</div>

<!-- Camera Popup -->
<div id="cameraPopup">
  <div id="cameraContainer">
    <video id="videoElement" autoplay playsinline></video>
    <canvas id="snapshotCanvas" style="display:none;"></canvas>
    <img id="snapshotPreview" alt="Snapshot Preview" />
    <br />
    <button id="captureButton">Capture</button>
    <button id="cancelCaptureButton">Cancel</button>
  </div>
</div>

<!-- Score form -->
<form id="scoreForm" class="score-input hidden" onsubmit="event.preventDefault(); submitScore();">
  <h2>Enter Score</h2>
  <div id="matchTitle" style="font-weight:bold; font-size:1.2rem; margin-bottom:5px;"></div>
  <div id="currentTurn" style="margin-bottom:15px;"></div>

  <label class="throw-label" for="throw1">Throw 1:</label>
  <input type="number" id="throw1" class="throw-input" min="0" max="180" required />
  <label class="throw-label" for="throw2">Throw 2:</label>
  <input type="number" id="throw2" class="throw-input" min="0" max="180" required />
  <label class="throw-label" for="throw3">Throw 3:</label>
  <input type="number" id="throw3" class="throw-input" min="0" max="180" required />
  <br />
  <button type="submit">Submit</button>
</form>

<div class="log" id="log" style="margin-top:15px; height:150px; overflow-y:auto; background:#222; padding:10px; border-radius:8px;"></div>

<script>
  // State
  let players = [];
  let playerImages = {}; // { playerName: base64Image }
  let scores = {};
  let currentPlayerIndex = 0;
  let gameMode = 501;
  let isTournament = false;

  let tournamentMatches = [];
  let currentMatchIndex = 0;
  let matchScores = {};
  let matchWinners = [];
  let matchLosers = [];

  // Camera elements
  const cameraPopup = document.getElementById("cameraPopup");
  const video = document.getElementById("videoElement");
  const canvas = document.getElementById("snapshotCanvas");
  const snapshotPreview = document.getElementById("snapshotPreview");
  const captureBtn = document.getElementById("captureButton");
  const cancelBtn = document.getElementById("cancelCaptureButton");
  let stream = null;
  let capturedImage = null;
  let newPlayerName = "";

  // Open camera popup and start video stream
  function openCamera(name) {
    newPlayerName = name;
    capturedImage = null;
    snapshotPreview.style.display = "none";
    captureBtn.textContent = "Capture";
    video.style.display = "block";
    video.play();

    cameraPopup.classList.add("visible");

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(s => {
        stream = s;
        video.srcObject = stream;
      })
      .catch(err => {
        alert("Camera access denied or not available.");
        cameraPopup.classList.remove("visible");
      });
  }

  // Close camera popup and stop video stream
  function closeCamera() {
    cameraPopup.classList.remove("visible");
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      stream = null;
    }
  }

  // Capture photo from video
  captureBtn.addEventListener("click", () => {
    if (!capturedImage) {
      // Take snapshot
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      capturedImage = canvas.toDataURL("image/png");
      snapshotPreview.src = capturedImage;
      snapshotPreview.style.display = "block";
      captureBtn.textContent = "Confirm";
      // Pause video preview and hide video
      video.pause();
      video.style.display = "none";
    } else {
      // Confirm and add player with image
      players.push(newPlayerName);
      playerImages[newPlayerName] = capturedImage;
      renderPlayerList();
      closeCamera();
      document.getElementById("playerName").value = "";
    }
  });

  cancelBtn.addEventListener("click", () => {
    closeCamera();
  });

  // Add player button clicked - open camera popup instead of adding immediately
  document.getElementById("addPlayerBtn").addEventListener("click", () => {
    const input = document.getElementById("playerName");
    const name = input.value.trim();
    if (!name) {
      alert("Please enter a player name.");
      return;
    }
    if (players.includes(name)) {
      alert("Player name already exists.");
      return;
    }
    openCamera(name);
  });

  // Show the list of players with their images
  function renderPlayerList() {
    const list = document.getElementById("playerList");
    if (players.length === 0) {
      list.innerHTML = "<li>No players added yet</li>";
      return;
    }
    list.innerHTML = players.map(p => {
      const imgSrc = playerImages[p] || "";
      const imgTag = imgSrc ? `<img src="${imgSrc}" alt="${p}"/>` : "";
      return `<li>${imgTag}${p}</li>`;
    }).join("");

    if (
      document.getElementById("tournamentMode").checked &&
      players.length >= 2 &&
      players.length <= 6
    ) {
      renderTournamentSelectors();
    } else {
      document.getElementById("tournamentMatches").classList.add("hidden");
    }
  }

  // Tournament selector rendering (your original logic)
  function renderTournamentSelectors() {
    const container = document.getElementById("tournamentMatches");
    container.innerHTML = "";
    container.classList.remove("hidden");
    const matchCount = Math.floor(players.length / 2);

    for (let i = 0; i < matchCount; i++) {
      const matchDiv = document.createElement("div");
      matchDiv.style.marginBottom = "10px";

      const p1select = document.createElement("select");
      p1select.id = `match_${i}_p1`;
      players.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        p1select.appendChild(opt);
      });

      const p2select = document.createElement("select");
      p2select.id = `match_${i}_p2`;
      players.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        p2select.appendChild(opt);
      });

      matchDiv.appendChild(document.createTextNode(`Match ${i + 1}: `));
      matchDiv.appendChild(p1select);
      matchDiv.appendChild(document.createTextNode(" vs "));
      matchDiv.appendChild(p2select);

      container.appendChild(matchDiv);
    }
  }

  // Start the game
  function startGame() {
    gameMode = parseInt(document.getElementById("gameMode").value);
    isTournament = document.getElementById("tournamentMode").checked;

    if (players.length < 2) {
      alert("You need at least 2 players to start.");
      return;
    }

    if (isTournament) {
      const matchCount = Math.floor(players.length / 2);
      tournamentMatches = [];

      const usedPlayers = new Set();
      for (let i = 0; i < matchCount; i++) {
        const p1 = document.getElementById(`match_${i}_p1`).value;
        const p2 = document.getElementById(`match_${i}_p2`).value;

        if (p1 === p2) {
          alert("A player cannot play against themselves.");
          return;
        }
        if (usedPlayers.has(p1) || usedPlayers.has(p2)) {
          alert("Players cannot be in multiple matches.");
          return;
        }

        tournamentMatches.push([p1, p2]);
        usedPlayers.add(p1);
        usedPlayers.add(p2);
      }
    } else {
      tournamentMatches = [players];
    }

    // Initialize scores for all players
    scores = {};
    for (const p of players) {
      scores[p] = { score: gameMode, history: [], average: 0 };
    }

    currentMatchIndex = 0;
    matchWinners = [];
    matchLosers = [];

    document.getElementById("setupSection").classList.add("hidden");
    document.getElementById("scoreForm").classList.remove("hidden");
    startMatch();
  }

  // Placeholder for startMatch function — implement your game logic here
  function startMatch() {
    updateMatchTitle();
    updateCurrentTurn();
    clearThrowInputs();
    log(`Match started: ${tournamentMatches[currentMatchIndex].join(" vs ")}`);
  }

  // Update match title on score form
  function updateMatchTitle() {
    const matchTitle = document.getElementById("matchTitle");
    if (isTournament) {
      matchTitle.textContent = `Match ${currentMatchIndex + 1}: ${tournamentMatches[currentMatchIndex][0]} vs ${tournamentMatches[currentMatchIndex][1]}`;
    } else {
      matchTitle.textContent = `Game: ${players.join(", ")}`;
    }
  }

  // Update current turn display
  function updateCurrentTurn() {
    const currentTurnDiv = document.getElementById("currentTurn");
    const currentPlayers = isTournament ? tournamentMatches[currentMatchIndex] : players;
    currentTurnDiv.textContent = `Current Player: ${currentPlayers[currentPlayerIndex]}`;
  }

  // Clear throw inputs
  function clearThrowInputs() {
    document.getElementById("throw1").value = "";
    document.getElementById("throw2").value = "";
    document.getElementById("throw3").value = "";
  }

  // Submit score (basic skeleton)
  function submitScore() {
    const t1 = parseInt(document.getElementById("throw1").value) || 0;
    const t2 = parseInt(document.getElementById("throw2").value) || 0;
    const t3 = parseInt(document.getElementById("throw3").value) || 0;

    const total = t1 + t2 + t3;

    const currentPlayers = isTournament ? tournamentMatches[currentMatchIndex] : players;
    const currentPlayer = currentPlayers[currentPlayerIndex];

    // Update score
    scores[currentPlayer].score -= total;
    if (scores[currentPlayer].score < 0) scores[currentPlayer].score = scores[currentPlayer].score + total; // bust (no change)

    log(`${currentPlayer} scored ${total}. Remaining: ${scores[currentPlayer].score}`);

    // Next player
    currentPlayerIndex++;
    if (currentPlayerIndex >= currentPlayers.length) currentPlayerIndex = 0;

    updateCurrentTurn();
    clearThrowInputs();

    // TODO: Add win checking, tournament match logic, etc.
  }

  // Log helper
  function log(msg) {
    const logDiv = document.getElementById("log");
    logDiv.innerHTML += `<div>${msg}</div>`;
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  // Freeze screen toggle logic (admin only: does not freeze admin screen itself)
  function toggleFreezeScreen() {
    const btn = document.getElementById("freezeToggleBtn");
    const freezeOn = btn.textContent.includes("OFF"); // if currently OFF, turn ON

    if (freezeOn) {
      localStorage.setItem("dartsFreezeScreen", "true");
      btn.textContent = "FREEZE SCREEN ON";
      btn.style.backgroundColor = "#27ae60";  // green
      btn.style.color = "#fff";
      log("Freeze Screen ENABLED (public display should freeze)");
    } else {
      localStorage.setItem("dartsFreezeScreen", "false");
      btn.textContent = "FREEZE SCREEN OFF";
      btn.style.backgroundColor = "#c0392b";  // red
      btn.style.color = "#fff";
      log("Freeze Screen DISABLED (public display should unfreeze)");
    }
  }

  // On load, set freeze button to saved state
  window.addEventListener("load", () => {
    const freeze = localStorage.getItem("dartsFreezeScreen") === "true";
    const btn = document.getElementById("freezeToggleBtn");
    if (freeze) {
      btn.textContent = "FREEZE SCREEN ON";
      btn.style.backgroundColor = "#27ae60";  // green
      btn.style.color = "#fff";
    } else {
      btn.textContent = "FREEZE SCREEN OFF";
      btn.style.backgroundColor = "#c0392b";  // red
      btn.style.color = "#fff";
    }
    renderPlayerList();
  });
</script>

</body>
</html>
