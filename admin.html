<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Darts Admin</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #1a1a1a;
      color: #fff;
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      color: #ffcc00;
    }
    select, input, button {
      font-size: 1rem;
      padding: 8px;
      margin: 5px;
    }
    .player-list {
      margin-top: 10px;
    }
    .score-input {
      margin-top: 20px;
    }
    .log {
      margin-top: 20px;
      max-height: 150px;
      overflow-y: auto;
      background: #222;
      padding: 10px;
    }
  </style>
</head>
<body>
  <h1>Darts Admin Panel</h1>

  <h2>Game Setup</h2>
  <label>Game Mode:</label>
  <select id="gameMode">
    <option value="301">301</option>
    <option value="501" selected>501</option>
    <option value="701">701</option>
    <option value="practice">Practice</option>
  </select>
  <br>
  <label>Tournament Mode:</label>
  <input type="checkbox" id="tournamentMode">

  <div>
    <label>Add Player:</label>
    <input type="text" id="playerName">
    <button onclick="addPlayer()">Add</button>
  </div>

  <div class="player-list" id="playerList"></div>

  <button onclick="startGame()">Start Game</button>

  <div class="score-input" id="scoreInput" style="display:none;">
    <h2>Enter Score</h2>
    <div id="matchTitle"></div>
    <div id="currentTurn"></div>
    <input type="number" id="score" min="0" max="180">
    <button onclick="submitScore()">Submit</button>
  </div>

  <div class="log" id="log"></div>

  <script>
    let players = [];
    let scores = {};
    let currentPlayerIndex = 0;
    let gameMode = 501;
    let isTournament = false;

    // Tournament state
    let tournamentMatches = [];
    let currentMatchIndex = 0;
    let matchScores = {};
    let matchWinners = [];
    let matchLosers = [];

    function addPlayer() {
      const name = document.getElementById('playerName').value.trim();
      if (!name) return;
      if (players.includes(name)) return alert("Player already added.");

      players.push(name);
      document.getElementById('playerName').value = '';
      updatePlayerList();
    }

    function updatePlayerList() {
      document.getElementById('playerList').innerHTML = '<ul>' +
        players.map(p => `<li>${p}</li>`).join('') + '</ul>';
    }

    function startGame() {
      if (players.length !== 4) {
        alert("Tournament mode currently supports exactly 4 players.");
        return;
      }

      gameMode = document.getElementById('gameMode').value;
      isTournament = document.getElementById('tournamentMode').checked;

      // Shuffle players
      players.sort(() => 0.5 - Math.random());

      scores = {};
      for (let p of players) {
        scores[p] = {
          score: parseInt(gameMode),
          history: [],
          average: 0
        };
      }

      if (isTournament) {
        tournamentMatches = [
          [players[0], players[1]], // Round 1 - Match 1
          [players[2], players[3]], // Round 1 - Match 2
          [], // Winner match
          []  // Loser match
        ];
        currentMatchIndex = 0;
      }

      document.getElementById('scoreInput').style.display = 'block';
      startMatch();
    }

    function startMatch() {
      const match = tournamentMatches[currentMatchIndex];
      matchScores = {};
      currentPlayerIndex = 0;

      for (let p of match) {
        scores[p].score = parseInt(gameMode);
        scores[p].history = [];
        scores[p].average = 0;
        matchScores[p] = scores[p];
      }

      localStorage.setItem('darts_game', JSON.stringify({
        mode: gameMode,
        players: match,
        scores: matchScores,
        currentPlayerIndex,
        isTournament,
        tournamentState: {
          matchIndex: currentMatchIndex,
          fullMatches: tournamentMatches
        }
      }));

      document.getElementById('matchTitle').textContent = `Match: ${match[0]} vs ${match[1]}`;
      updateCurrentTurn();
      log(`Started match: ${match[0]} vs ${match[1]}`);
    }

    function updateCurrentTurn() {
      const match = tournamentMatches[currentMatchIndex];
      const player = match[currentPlayerIndex];
      document.getElementById('currentTurn').textContent = `Current Player: ${player} (Score: ${matchScores[player].score})`;
    }

    function submitScore() {
      const match = tournamentMatches[currentMatchIndex];
      const player = match[currentPlayerIndex];
      const val = parseInt(document.getElementById('score').value);

      if (isNaN(val) || val < 0 || val > 180) return;

      const newScore = matchScores[player].score - val;

      if (newScore < 0) {
        log(`${player} busts with ${val}!`);
      } else {
        matchScores[player].score = newScore;
        matchScores[player].history.push(val);
        const total = matchScores[player].history.reduce((a, b) => a + b, 0);
        matchScores[player].average = (total / matchScores[player].history.length).toFixed(2);

        if (newScore === 0) {
          log(`${player} wins the match!`);
          if (currentMatchIndex === 0 || currentMatchIndex === 1) {
            matchWinners.push(player);
            matchLosers.push(match.find(p => p !== player));
          } else if (currentMatchIndex === 2) {
            log(`üèÜ Tournament Winner: ${player}`);
          } else {
            log(`ü•â 3rd Place Winner: ${player}`);
          }

          currentMatchIndex++;
          if (currentMatchIndex === 2) {
            tournamentMatches[2] = [matchWinners[0], matchWinners[1]];
            tournamentMatches[3] = [matchLosers[0], matchLosers[1]];
            startMatch();
          } else if (currentMatchIndex === 4) {
            document.getElementById('scoreInput').style.display = 'none';
            showFinalResults();
          } else {
            startMatch();
          }
          return;
        }
      }

      currentPlayerIndex = (currentPlayerIndex + 1) % 2;
      updateCurrentTurn();
      localStorage.setItem('darts_game', JSON.stringify({
        mode: gameMode,
        players: match,
        scores: matchScores,
        currentPlayerIndex,
        isTournament,
        tournamentState: {
          matchIndex: currentMatchIndex,
          fullMatches: tournamentMatches
        }
      }));
    }

    function log(message) {
      const logEl = document.getElementById('log');
      logEl.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function showFinalResults() {
      const placements = [
        matchWinners[0], // 1st
        matchWinners[1], // 2nd
        matchLosers[0],  // 3rd
        matchLosers[1]   // 4th
      ];

      localStorage.setItem('darts_final_results', JSON.stringify(placements));
    }
  </script>
</body>
</html>

