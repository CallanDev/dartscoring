<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>dartScore - Admin</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #111;
      color: #fff;
      padding: 20px;
    }
    h1, h2 {
      color: #ffcc00;
    }
    button, select, input {
      margin: 5px 0;
      padding: 10px;
      font-size: 1rem;
    }
    #logoToggle {
      background: red;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
    }
    #logoToggle.active {
      background: green;
    }
    .section {
      margin-top: 20px;
    }
    .log {
      background: #222;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <h1>Darts Admin Panel</h1>

  <div class="section">
    <h2>Game Setup</h2>
    <label>Game Mode:</label>
    <select id="gameMode">
      <option value="practice">Practice</option>
      <option value="301">301</option>
      <option value="501" selected>501</option>
      <option value="701">701</option>
      <option value="lastman">Last Man Standing</option>
      <option value="ballsmash">Ball Smash</option>
    </select>
    <br />
    <button onclick="openJoining()">Open Joining</button>
    <button onclick="startGame()">Start Game</button>
    <button onclick="endGame()">End Game</button>
    <br />
    <button id="logoToggle" onclick="toggleLogo()">LOGO SCREEN</button>
  </div>

  <div id="scoreSection" class="section" style="display:none;">
    <h2>Enter Score</h2>
    <div id="currentPlayerDisplay"></div>
    <label>Throw 1:</label>
    <input type="number" id="throw1" min="0" max="180" /><br/>
    <label>Throw 2:</label>
    <input type="number" id="throw2" min="0" max="180" /><br/>
    <label>Throw 3:</label>
    <input type="number" id="throw3" min="0" max="180" /><br/>
    <button onclick="submitScore()">Submit Score</button>
  </div>

  <div class="section log" id="log"></div>

  <script>
    let gameData = {
      active: false,
      mode: '501',
      players: [],
      scores: {},
      turn: 0,
      log: [],
      allowJoin: false
    };

    function openJoining() {
      gameData.allowJoin = true;
      gameData.active = false;
      gameData.players = [];
      gameData.scores = {};
      gameData.turn = 0;
      sync();
      log("Joining opened. Waiting for players.");
    }

    function startGame() {
      if (gameData.players.length < 1) {
        alert("No players have joined.");
        return;
      }
      gameData.mode = document.getElementById('gameMode').value;
      gameData.active = true;
      gameData.allowJoin = false;
      gameData.scores = {};
      gameData.turn = 0;
      for (const p of gameData.players) {
        gameData.scores[p.name] = {
          score: ['301', '501', '701'].includes(gameData.mode) ? parseInt(gameData.mode) : 0,
          history: [],
          average: 0,
          total: 0,
          shots: 0
        };
      }
      document.getElementById('scoreSection').style.display = 'block';
      updateCurrentPlayerDisplay();
      sync();
      log("Game started.");
    }

    function endGame() {
      gameData.active = false;
      gameData.allowJoin = false;
      sync();
      document.getElementById('scoreSection').style.display = 'none';
      log("Game ended.");
    }

    function toggleLogo() {
      const btn = document.getElementById('logoToggle');
      const active = btn.classList.toggle('active');
      localStorage.setItem("darts_logo", active ? "on" : "off");
    }

    function updateCurrentPlayerDisplay() {
      const player = gameData.players[gameData.turn];
      document.getElementById('currentPlayerDisplay').innerText = "Current Player: " + player.name;
    }

    function submitScore() {
      const p = gameData.players[gameData.turn].name;
      const t1 = parseInt(document.getElementById("throw1").value) || 0;
      const t2 = parseInt(document.getElementById("throw2").value) || 0;
      const t3 = parseInt(document.getElementById("throw3").value) || 0;
      const total = t1 + t2 + t3;

      let ps = gameData.scores[p];
      if (gameData.mode === "practice") {
        ps.total += total;
        ps.shots += 3;
      } else {
        if (ps.score - total >= 0) {
          ps.score -= total;
        }
        ps.total += total;
        ps.shots += 3;
        if (ps.score === 0) {
          log(`${p} has finished the game!`);
        }
      }

      ps.history.push(total);
      ps.average = (ps.total / ps.shots).toFixed(2);
      log(`${p} scored ${total}. New score: ${ps.score || ps.total}`);
      
      document.getElementById("throw1").value = "";
      document.getElementById("throw2").value = "";
      document.getElementById("throw3").value = "";

      gameData.turn = (gameData.turn + 1) % gameData.players.length;
      updateCurrentPlayerDisplay();
      sync();
    }

    function log(msg) {
      const el = document.getElementById("log");
      el.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${msg}</div>`;
      el.scrollTop = el.scrollHeight;
    }

    function sync() {
      localStorage.setItem("darts_game", JSON.stringify(gameData));
    }

    // Initial setup
    setInterval(() => {
      const joinList = JSON.parse(localStorage.getItem("darts_joined") || "[]");
      if (gameData.allowJoin) {
        gameData.players = joinList;
        sync();
      }
    }, 1000);
  </script>
</body>
</html>
